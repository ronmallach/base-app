{% extends 'base.html' %}

{% block content %}

<div class='w3-container w3-light-grey' id='everything'>
  <div class="w3-col w3-border s2" id="pastePanel">
    <p> Lets type up some instructions here </p>
    <a href="{{ url_for('blueprint.download_file') }}">1. Download Template</a>
    <textarea type='text' id='userpaste' placeholder='2. Paste Excel Data Here'></textarea>
    <p>3. What is this input Data?</p>
    <select id='calOrpol' class='w3-select w3-border'>
      <option value="calibrate">Historical Data</option>
      <option value="policy">Policy Implementation</option>
    </select>
    <p></p>
    <button class='w3-button w3-dark-grey' onclick='clip()'>4. Upload Data</button>
    <p></p>
    <button class='w3-button w3-dark-grey' onclick='calibrate()'>5. Calibrate Models</button>
  </div>
  <div class='w3-col s6' style="overflow-y:scroll; height:90vh">
    <table id=usertable class='w3-table-all w3-hoverable w3-tiny w3-centered'></table>
  </div>
  <div class='w3-col s3' style="overflow-y:scroll; height:90vh">
    <div class='w3-border' id=inputGraphCases></div>
    <div class='w3-border' id=inputGraphHospital></div>
    <div class='w3-border' id=inputGraphDeath></div>
    <div class='w3-border' id=inputGraphTest></div>
  </div>
</div>

<script>

function clip() {
    var text = d3.select("#userpaste")._groups[0][0].value // get user pasted data
    clipRows = text.split(String.fromCharCode(10));  // split into rows
    for (i=0; i<clipRows.length; i++) {
        // split rows into columns
        clipRows[i] = clipRows[i].split(String.fromCharCode(9));
    }
    document.getElementById('usertable').innerHTML = '' // clear old table if any
    table = document.getElementById("usertable") // establish new table

    for (i=0; i<clipRows.length - 1; i++) {
        newRow = table.insertRow();
        for (j=0; j<clipRows[i].length; j++) {
            newCell = newRow.insertCell();
            if (clipRows[i][j].length == 0) {
                newCell.contentEditable = true

                newCell.innerText = '';
            }
            else {
                newCell.contentEditable = true
                newCell.innerText = clipRows[i][j];
            }
        }
    }
    inputType = document.getElementById('calOrpol').value
    data = tableToJson('usertable')
    if (inputType == 'calibrate'){
      makeUserInputLine('inputGraphCases', 'viewInputCases', data, dataType='Cases')
      makeUserInputLine('inputGraphHospital', 'viewInputHospital', data, dataType='Hospitalization')
      makeUserInputLine('inputGraphDeath', 'viewInputDeath', data, dataType='Deaths')
      makeUserInputLine('inputGraphTest', 'viewInputTest', data, dataType='Tests')
    }else{
      makeUserInputLine('inputGraphCases', 'viewInputCases', data, dataType='Scenario1-Param1')
      makeUserInputLine('inputGraphHospital', 'viewInputHospital', data, dataType='Scenario1-Param2')
      makeUserInputLine('inputGraphDeath', 'viewInputDeath', data, dataType='Scenario1-Param3')
    }
}

function calibrate(){
  to_python = tableToJson("usertable")
  $.ajax({
        type: "POST",
        url: "calibrate_model", // url on python side
        data: JSON.stringify(to_python),
        contentType: "application/json",
        success: function (dataset) {
          all_data = dataset.data;
          console.log(all_data)
        },
  });
}

function tableToJson(id) {
  var table = document.getElementById(id)
  var data = [];
  // first row needs to be headers
  var headers = [];
  for (var i=0; i<table.rows[0].cells.length; i++) {
      headers[i] = table.rows[0].cells[i].innerHTML.replace(/ /gi,'');
  }
  // go through cells
	start = 1
  for (var i=start; i<table.rows.length; i++) {
      var tableRow = table.rows[i];
      var rowData = {};
      for (var j=0; j<tableRow.cells.length ; j++) {
          rowData[headers[j]] = tableRow.cells[j].innerHTML;
      }
      data.push(rowData);
  }
  return data;
}
</script>
{% endblock %}
